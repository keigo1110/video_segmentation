# 動的物体検出とマスク処理システム

このプロジェクトは、3次元再構築時に発生する「動的物体のゴースト」を防ぐための動的物体検出・マスク処理システムです。単眼カメラからの一人称視点画像を対象に、リアルタイムに動的物体を検出し、マスク処理を行います。

## 概要

システムは以下の流れで動作します：

1. 最新画像と過去画像の単眼深度推定
2. 3次元点群への変換
3. 過去点群の座標変換（最新視点へ）
4. 点群比較による動的物体検出
5. セグメンテーションによる物体領域抽出
6. 動的物体マスクの生成
7. 過去画像へのマスク適用

## 必要条件

以下の環境が必要です：

- Python 3.8以上
- CUDA対応GPU（NVIDIA RTX 3090以上推奨）
- 必要なパッケージ（requirements.txtに記載）

## インストール方法

1. リポジトリをクローンします：
   ```
   git clone <リポジトリURL>
   cd <リポジトリディレクトリ>
   ```

2. 必要なパッケージをインストールします：
   ```
   pip install -r obj_change/requirements.txt
   ```

3. 必要なモデルをダウンロードします：
   - FastSAM-x.ptモデル（既にリポジトリに含まれている場合は不要）
   - Depth Anything V2は初回実行時に自動的にダウンロードされます

## 使用方法

基本的な使用方法は以下の通りです：

```
python obj_change/main.py --latest <最新画像パス> --past <過去画像パス> --poses <カメラ姿勢ファイル> --intrinsics <カメラ内部パラメータファイル> --output <出力ディレクトリ>
```

### 引数

- `--latest`: 最新画像のパス（必須）
- `--past`: 過去画像のパス（必須）
- `--poses`: カメラ姿勢情報のJSONファイル（必須）
- `--intrinsics`: カメラ内部パラメータのJSONファイル（必須）
- `--output`: 出力ディレクトリ（デフォルト: "output"）
- `--dist_threshold`: 動的物体と判定する距離閾値（メートル、デフォルト: 0.2）
- `--dyn_threshold`: セグメントが動的と判定する閾値（セグメント内の動的ピクセル割合、デフォルト: 0.5）

### 入力ファイル形式

1. カメラ姿勢情報ファイル（JSON形式）：
```json
{
  "image_id_1": [
    [r11, r12, r13, tx],
    [r21, r22, r23, ty],
    [r31, r32, r33, tz],
    [0, 0, 0, 1]
  ],
  "image_id_2": [
    ...
  ],
  ...
}
```

2. カメラ内部パラメータファイル（JSON形式）：
```json
{
  "fx": 500.0,
  "fy": 500.0,
  "cx": 320.0,
  "cy": 240.0
}
```

### 出力

プログラムは以下のファイルを出力ディレクトリに保存します：

- `comparison_*.jpg`: 最新画像、過去画像、マスク画像、動的マスクの比較画像
- `latest_*.jpg`: 最新画像
- `past_*.jpg`: 過去画像（元画像）
- `masked_*.jpg`: マスク適用後の過去画像
- `mask_*.jpg`: 動的物体のマスク画像

## 技術詳細

このシステムでは以下の技術を使用しています：

- **深度推定**: Depth Anything V2
- **点群処理**: Faiss (GPU版)
- **セグメンテーション**: FastSAM

## トラブルシューティング

- **GPUメモリ不足エラー**: モデルサイズを小さくするか、バッチサイズを減らしてください
- **モデルファイルが見つからないエラー**: モデルファイルのパスを確認してください
- **動的物体が検出されない**: 距離閾値（--dist_threshold）を調整してください
- **誤検出が多い**: 動的物体判定閾値（--dyn_threshold）を調整してください

## ライセンス

このプロジェクトは[ライセンス名]の下で公開されています。 